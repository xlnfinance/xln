#!/bin/bash
export PATH="/opt/homebrew/bin:/Users/$(whoami)/Library/Python/3.9/bin:/usr/bin:$PATH"
export LANG=en_US.UTF-8

LOG="/tmp/vr-debug.log"
LOCKFILE="/tmp/vr-transcribe.lock"

# Prevent race conditions - only one transcription at a time
if [ -f "$LOCKFILE" ]; then
    LOCK_PID=$(cat "$LOCKFILE" 2>/dev/null)
    if kill -0 "$LOCK_PID" 2>/dev/null; then
        echo "=== $(date '+%H:%M:%S') BLOCKED (PID $LOCK_PID active) ===" >> "$LOG"
        exit 5
    fi
fi
echo $$ > "$LOCKFILE"
trap 'rm -f "$LOCKFILE"; kill -INT $(jobs -p) 2>/dev/null' EXIT TERM INT

echo "=== $(date '+%H:%M:%S') START ===" >> "$LOG"

LANG_ARG="${1:-auto}"
AUDIO=~/records/$(date +%Y-%m-%d)/$(date +%H-%M-%S).wav
mkdir -p $(dirname "$AUDIO")
echo "File: $AUDIO" >> "$LOG"

rec "$AUDIO" rate 16k channels 1 2>/dev/null &
REC_PID=$!
echo "Recording PID: $REC_PID" >> "$LOG"

wait $REC_PID 2>/dev/null
REC_EXIT=$?
echo "rec exit code: $REC_EXIT" >> "$LOG"

sleep 0.3

if [ ! -s "$AUDIO" ]; then
    echo "ERROR: No audio file" >> "$LOG"
    exit 2
fi

SIZE=$(stat -f%z "$AUDIO" 2>/dev/null || echo 0)
echo "Audio size: $SIZE bytes" >> "$LOG"

START=$(python3 -c "import time; print(int(time.time()*1000))")

echo "Trying HTTP transcribe..." >> "$LOG"
RES=$(curl -sf --max-time 100 http://localhost:5001/transcribe -F "file=@$AUDIO" -F "task=$([ "$LANG_ARG" = "translate-en" ] && echo translate || echo transcribe)" 2>&1)
CURL_EXIT=$?

if [ $CURL_EXIT -ne 0 ]; then
    echo "ERROR: HTTP failed (curl exit $CURL_EXIT)" >> "$LOG"
    exit 4
fi

TEXT=$(echo "$RES" | python3 -c "import sys,json; print(json.load(sys.stdin).get('text',''))" 2>/dev/null)
echo "HTTP result: $TEXT" >> "$LOG"

if [ -z "$TEXT" ]; then
    echo "ERROR: Empty response from server" >> "$LOG"
    exit 4
fi

MS=$(( $(python3 -c "import time; print(int(time.time()*1000))") - START ))
echo "Transcribe time: ${MS}ms" >> "$LOG"

echo "Pasting: $TEXT" >> "$LOG"

printf "%s" "$TEXT" | pbcopy

VERIFIED=false
for i in {1..20}; do
    CURRENT=$(pbpaste 2>/dev/null)
    if [ "$CURRENT" = "$TEXT" ]; then
        VERIFIED=true
        echo "Clipboard ready after ${i}0ms" >> "$LOG"
        break
    fi
    sleep 0.01
done

if [ "$VERIFIED" = false ]; then
    echo "ERROR: Clipboard not ready" >> "$LOG"
    exit 8
fi

ACTIVE_APP=$(osascript -e 'tell application "System Events" to get name of first process whose frontmost is true' 2>/dev/null)
echo "Active app: $ACTIVE_APP" >> "$LOG"

if [[ "$ACTIVE_APP" =~ (ghostty|iTerm|Terminal|Warp|Alacritty|kitty) ]]; then
    osascript -e 'tell application "System Events" to keystroke "v" using command down' 2>/dev/null
    echo "SUCCESS: ${MS}ms (terminal)" >> "$LOG"
else
    ESCAPED=$(printf "%s" "$TEXT" | sed 's/\\/\\\\/g; s/"/\\"/g')
    osascript -e "tell application \"System Events\" to keystroke \"$ESCAPED\"" 2>> "$LOG"
    echo "SUCCESS: ${MS}ms (GUI)" >> "$LOG"
fi

echo "$MS"
