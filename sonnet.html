<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLN Sonnet Wallet - Svelte Edition</title>
    <script src="https://unpkg.com/svelte@4/dist/svelte.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            overflow-x: hidden;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            padding-bottom: 70px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-bar {
            background: rgba(255,255,255,0.1);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            font-family: monospace;
            backdrop-filter: blur(10px);
        }

        .entity-filter {
            background: rgba(255,255,255,0.9);
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .entity-filter label {
            font-weight: bold;
            color: #2c3e50;
        }

        .entity-filter select {
            padding: 5px 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background: white;
        }

        .entities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 15px;
            margin-bottom: 30px;
        }

        .entity-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            width: 100%;
        }

        .entity-card:hover {
            transform: translateY(-5px);
        }

        .entity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .entity-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #2c3e50;
            text-transform: uppercase;
        }

        .entity-mode {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
        }

        .mode-proposer-based {
            background: #3498db;
        }

        .mode-gossip-based {
            background: #9b59b6;
        }

        .threshold-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 8px;
            margin-top: 10px;
            font-size: 0.85em;
        }

        .power-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 5px;
        }

        .power-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .replica-stats {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.85em;
        }

        .messages-section {
            margin-top: 15px;
            max-height: 280px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 0.85em;
        }

        .message {
            margin: 5px 0;
            padding: 8px;
            font-size: 0.85em;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #fff;
            line-height: 1.4;
        }

        .message.collective {
            background: #e3f2fd;
            padding: 5px;
            border-radius: 5px;
            font-weight: bold;
            color: #1565c0;
        }

        .server-io-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .server-column {
            background: rgba(255,255,255,0.95);
            border: 2px solid #007bff;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85em;
        }

        .server-column-header {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #dee2e6;
        }

        .server-section {
            margin-bottom: 20px;
        }

        .server-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 0.9em;
            font-weight: bold;
        }

        .input-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', monospace;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .no-inputs {
            color: #6c757d;
            font-style: italic;
        }

        .actionable-tabs-container {
            background: rgba(255,255,255,0.95);
            border: 2px solid #007bff;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            background: transparent;
            border: none;
            padding: 15px 20px;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button:hover {
            background: rgba(0, 123, 255, 0.1);
            color: #007bff;
        }

        .tab-button.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        .control-group select,
        .control-group input {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto;
        }

        .simple-formation-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .formation-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .formation-group label {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }

        .formation-group input, .formation-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            transition: border-color 0.3s ease;
        }

        .formation-group input:focus, .formation-group select:focus {
            outline: none;
            border-color: #28a745;
        }

        .validators-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .validators-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .validator-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .validator-name {
            flex: 2;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .validator-weight {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .threshold-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .threshold-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #495057;
        }

        .threshold-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            margin-bottom: 10px;
        }

        .time-machine {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(15, 15, 15, 0.96);
            backdrop-filter: blur(20px);
            padding: 12px 20px;
            border-top: 1px solid #007bff;
            z-index: 1000;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.4);
        }

        .time-machine-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 15px;
        }

        .time-info-compact {
            display: flex;
            align-items: center;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75em;
            color: #aaa;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }

        .time-info-compact.current {
            color: #00ff88;
            font-weight: bold;
        }

        .time-nav-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .time-utility-controls {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .time-btn-compact {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75em;
            transition: all 0.15s ease;
            min-width: 28px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-btn-compact:hover {
            background: #007bff;
            border-color: #007bff;
            transform: translateY(-1px);
        }

        .time-btn-compact.live {
            background: #00ff88;
            color: #000;
            border-color: #00ff88;
            font-weight: bold;
            padding: 4px 10px;
            min-width: 45px;
        }

        .time-btn-mini {
            background: #333;
            color: #aaa;
            border: 1px solid #555;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7em;
            transition: all 0.15s ease;
            min-width: 22px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .time-btn-mini:hover {
            background: #555;
            color: white;
        }

        .time-btn-mini.warning {
            background: #ffc107;
            color: #212529;
            border-color: #ffc107;
        }

        .time-slider-container {
            position: relative;
            width: 100%;
            max-width: 100%;
        }

        .time-slider {
            width: 100%;
            height: 4px;
            border-radius: 2px;
            background: #333;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
            transition: background 0.1s ease;
        }

        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: linear-gradient(45deg, #007bff, #0056b3);
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0,123,255,0.4);
            transition: all 0.2s ease;
        }

        .reload-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .reload-indicator.show {
            opacity: 1;
        }

        .debug-log {
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.8em;
            margin-top: 10px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // Main Svelte App Component
        const { createComponent } = Svelte;

        // Import XLN module
        let XLN;

        // Component definition using Svelte's reactive approach
        const App = createComponent(($$self, $$props, $$invalidate) => {
            // Reactive state variables
            let xlnEnv = null;
            let currentTimeIndex = -1;
            let selectedEntity = 'all';
            let selectedReplica = '';
            let selectedAction = 'chat';
            let activeTab = 'controls';
            let inputMessage = '';
            let proposalText = '';
            let selectedProposal = '';
            let voteChoice = 'yes';
            let entityName = '';
            let validators = [
                { name: 'alice', weight: 1 },
                { name: 'bob', weight: 1 },
                { name: 'carol', weight: 1 }
            ];
            let threshold = 2;
            let logs = [];
            let lastModified = null;

            // Reactive computations
            $: totalWeight = validators.reduce((sum, v) => sum + v.weight, 0);
            $: filteredReplicas = getFilteredReplicas(xlnEnv, selectedEntity, currentTimeIndex);
            $: entityOptions = getEntityOptions(xlnEnv);
            $: replicaOptions = getReplicaOptions(xlnEnv);
            $: proposalOptions = getProposalOptions(xlnEnv, selectedReplica);
            $: serverData = getServerData(xlnEnv, currentTimeIndex);
            $: timeMachineData = getTimeMachineData(currentTimeIndex);
            $: statusText = getStatusText(xlnEnv, entityOptions);

            // Utility functions
            const addLog = (message, type = 'info') => {
                const timestamp = new Date().toLocaleTimeString();
                logs = [...logs.slice(-99), { timestamp, message, type }];
                console.log(`[${timestamp}] ${message}`);
                $$invalidate('logs', logs);
            };

            const getStatusText = (env, options) => {
                if (env) {
                    const entityCount = options.length - 1;
                    return `✅ Connected | Height: ${env.height} | Entities: ${entityCount}`;
                }
                return '❌ Disconnected';
            };

            const getFilteredReplicas = (env, filter, timeIndex) => {
                if (!env) return new Map();
                
                let replicasToShow, snapshot;
                let isHistorical = false;
                
                if (timeIndex >= 0) {
                    snapshot = XLN.getSnapshot(timeIndex);
                    if (snapshot) {
                        replicasToShow = snapshot.replicas;
                        isHistorical = true;
                    }
                }
                
                if (!replicasToShow) {
                    replicasToShow = env.replicas;
                    currentTimeIndex = -1;
                    $$invalidate('currentTimeIndex', currentTimeIndex);
                }
                
                const filtered = new Map();
                replicasToShow.forEach((replica, key) => {
                    if (filter === 'all' || replica.entityId === filter) {
                        filtered.set(key, { ...replica, isHistorical });
                    }
                });
                
                return filtered;
            };

            const getEntityOptions = (env) => {
                if (!env) return [{ value: 'all', label: 'All Entities' }];
                const entityTypes = [...new Set(Array.from(env.replicas.keys()).map(key => key.split(':')[0]))];
                return [{ value: 'all', label: 'All Entities' }, ...entityTypes.map(type => ({ value: type, label: type.toUpperCase() }))];
            };

            const getReplicaOptions = (env) => {
                if (!env) return [];
                return Array.from(env.replicas.entries()).map(([key, replica]) => ({
                    value: key,
                    label: `${replica.entityId}:${replica.signerId} ${replica.isProposer ? '(👑 Proposer)' : '(✅ Validator)'}`
                }));
            };

            const getProposalOptions = (env, replicaKey) => {
                if (!env || !replicaKey) return [];
                const replica = env.replicas.get(replicaKey);
                if (!replica || !replica.state.proposals.size) return [];
                
                const options = [];
                replica.state.proposals.forEach((proposal, proposalId) => {
                    if (proposal.status === 'pending') {
                        options.push({
                            value: proposalId,
                            label: `${proposal.action.data.message} (by ${proposal.proposer})`
                        });
                    }
                });
                
                return options.length ? options : [{ value: '', label: 'No pending proposals' }];
            };

            const getServerData = (env, timeIndex) => {
                if (!env) return null;
                
                let serverInput, serverOutputs;
                let isHistorical = false;
                
                if (timeIndex >= 0) {
                    const snapshot = XLN.getSnapshot(timeIndex);
                    if (snapshot) {
                        serverInput = snapshot.serverInput;
                        serverOutputs = snapshot.serverOutputs || [];
                        isHistorical = true;
                    }
                }
                
                if (!serverInput) {
                    const history = XLN.getHistory();
                    if (history.length > 0) {
                        serverInput = history[history.length - 1].serverInput;
                        serverOutputs = history[history.length - 1].serverOutputs || [];
                    }
                }
                
                return { serverInput, serverOutputs, isHistorical };
            };

            const getTimeMachineData = (timeIndex) => {
                const history = XLN.getHistory();
                
                if (history.length === 0) {
                    return {
                        disabled: true,
                        max: 0,
                        value: 0,
                        info: '⏰ No history yet',
                        isCurrent: false,
                        progress: 0
                    };
                }
                
                const maxMeaningfulIndex = Math.max(0, history.length - 2);
                let sliderValue, progressPercent, info, isCurrent;
                
                if (timeIndex === -1) {
                    sliderValue = maxMeaningfulIndex + 1;
                    progressPercent = 100;
                    info = `⏰ LIVE | Height: ${xlnEnv?.height || 0} | ${history.length} snapshots`;
                    isCurrent = true;
                } else {
                    sliderValue = timeIndex;
                    const sliderMax = maxMeaningfulIndex + 1;
                    progressPercent = sliderMax > 0 ? (timeIndex / sliderMax) * 100 : 0;
                    const snapshot = history[timeIndex];
                    info = `📸 ${timeIndex + 1}/${history.length} | Height: ${snapshot?.height || 0} | ${snapshot?.description || 'Unknown'}`;
                    isCurrent = false;
                }
                
                return {
                    disabled: false,
                    max: maxMeaningfulIndex + 1,
                    value: sliderValue,
                    info,
                    isCurrent,
                    progress: progressPercent
                };
            };

            // Event handlers
            const switchTab = (tabName) => {
                activeTab = tabName;
                $$invalidate('activeTab', activeTab);
            };

            const executeAction = () => {
                if (!xlnEnv) {
                    alert('XLN Environment not initialized');
                    return;
                }
                
                currentTimeIndex = -1;
                $$invalidate('currentTimeIndex', currentTimeIndex);
                
                const replica = xlnEnv.replicas.get(selectedReplica);
                if (!replica) {
                    alert('Please select a valid replica');
                    return;
                }
                
                let entityTx;
                
                if (selectedAction === 'chat') {
                    if (!inputMessage.trim()) {
                        alert('Please enter a message');
                        return;
                    }
                    
                    entityTx = {
                        type: 'chat',
                        data: { from: replica.signerId, message: inputMessage.trim() }
                    };
                    
                    inputMessage = '';
                    $$invalidate('inputMessage', inputMessage);
                } else if (selectedAction === 'propose') {
                    if (!proposalText.trim()) {
                        alert('Please enter a proposal');
                        return;
                    }
                    
                    entityTx = {
                        type: 'propose',
                        data: {
                            action: { type: 'collective_message', data: { message: proposalText.trim() } },
                            proposer: replica.signerId
                        }
                    };
                    
                    proposalText = '';
                    $$invalidate('proposalText', proposalText);
                } else if (selectedAction === 'vote') {
                    if (!selectedProposal) {
                        alert('No proposal selected or no pending proposals');
                        return;
                    }
                    
                    entityTx = {
                        type: 'vote',
                        data: {
                            proposalId: selectedProposal,
                            voter: replica.signerId,
                            choice: voteChoice
                        }
                    };
                }
                
                // Process transaction
                let outputs = XLN.processServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: [{
                        entityId: replica.entityId,
                        signerId: replica.signerId,
                        entityTxs: [entityTx]
                    }]
                });
                
                // Process outputs until empty
                while (outputs.length > 0) {
                    const newOutputs = XLN.processServerInput(xlnEnv, {
                        serverTxs: [],
                        entityInputs: outputs
                    });
                    outputs.splice(0, outputs.length, ...newOutputs);
                }
                
                addLog(`✅ Executed ${selectedAction} action for ${replica.entityId}:${replica.signerId}`, 'success');
                
                // Trigger reactivity
                $$invalidate('xlnEnv', xlnEnv);
            };

            const createEntity = () => {
                if (!xlnEnv) return;
                
                currentTimeIndex = -1;
                $$invalidate('currentTimeIndex', currentTimeIndex);
                
                if (!entityName.trim()) {
                    alert('Please enter an entity name');
                    return;
                }
                
                if (!/^[a-zA-Z0-9_-]+$/.test(entityName)) {
                    alert('Entity name can only contain letters, numbers, underscores, and hyphens');
                    return;
                }
                
                const existingEntity = Array.from(xlnEnv.replicas.keys()).find(key => key.startsWith(entityName + ':'));
                if (existingEntity) {
                    alert(`Entity "${entityName}" already exists`);
                    return;
                }
                
                // Validate validators
                for (const validator of validators) {
                    if (!validator.name.trim()) {
                        alert('Please enter a name for all validators');
                        return;
                    }
                    if (!/^[a-zA-Z0-9_-]+$/.test(validator.name)) {
                        alert(`Validator name "${validator.name}" can only contain letters, numbers, underscores, and hyphens`);
                        return;
                    }
                    if (validator.weight < 1) {
                        alert(`Validator "${validator.name}" must have a weight of at least 1`);
                        return;
                    }
                }
                
                // Check for duplicate validator names
                const names = validators.map(v => v.name);
                if (new Set(names).size !== names.length) {
                    alert('Validator names must be unique');
                    return;
                }
                
                if (threshold > totalWeight) {
                    alert(`Threshold ${threshold} is higher than total weight ${totalWeight}`);
                    return;
                }
                
                // Create consensus config
                const config = {
                    mode: 'proposer-based',
                    threshold: BigInt(threshold),
                    validators: validators.map(v => v.name),
                    shares: validators.reduce((acc, v) => {
                        acc[v.name] = BigInt(v.weight);
                        return acc;
                    }, {})
                };
                
                // Create server transactions for all validators
                const serverTxs = validators.map((validator, index) => ({
                    type: 'importReplica',
                    entityId: entityName,
                    signerId: validator.name,
                    data: {
                        config: config,
                        isProposer: index === 0
                    }
                }));
                
                // Process the server transactions
                let outputs = XLN.processServerInput(xlnEnv, {
                    serverTxs: serverTxs,
                    entityInputs: []
                });
                
                // Process outputs until empty
                while (outputs.length > 0) {
                    const newOutputs = XLN.processServerInput(xlnEnv, {
                        serverTxs: [],
                        entityInputs: outputs
                    });
                    outputs.splice(0, outputs.length, ...newOutputs);
                }
                
                addLog(`✅ Entity "${entityName}" created successfully! Validators: ${validators.map(v => v.name).join(', ')}, Threshold: ${threshold}/${totalWeight}`, 'success');
                
                // Clear form
                entityName = '';
                validators = [
                    { name: 'alice', weight: 1 },
                    { name: 'bob', weight: 1 },
                    { name: 'carol', weight: 1 }
                ];
                threshold = 2;
                
                $$invalidate('entityName', entityName);
                $$invalidate('validators', validators);
                $$invalidate('threshold', threshold);
                $$invalidate('xlnEnv', xlnEnv);
            };

            const addValidator = () => {
                validators = [...validators, { name: '', weight: 1 }];
                $$invalidate('validators', validators);
            };

            const removeValidator = (index) => {
                if (validators.length > 1) {
                    validators = validators.filter((_, i) => i !== index);
                    $$invalidate('validators', validators);
                } else {
                    alert('Must have at least one validator');
                }
            };

            const simulateChat = () => {
                if (!xlnEnv) return;
                
                currentTimeIndex = -1;
                $$invalidate('currentTimeIndex', currentTimeIndex);
                
                const entities = ['chat', 'trading', 'governance'];
                const users = ['alice', 'bob', 'carol', 'david', 'eve'];
                const messages = [
                    'Hello everyone!',
                    'How is the consensus working?',
                    'This is a test message',
                    'Great to see multi-entity support',
                    'Byzantine fault tolerance rocks!'
                ];
                
                const entityId = entities[Math.floor(Math.random() * entities.length)];
                const from = users[Math.floor(Math.random() * users.length)];
                const message = messages[Math.floor(Math.random() * messages.length)];
                
                let outputs = XLN.processServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs: [{
                        entityId,
                        signerId: 'alice',
                        entityTxs: [{
                            type: 'chat',
                            data: { from, message }
                        }]
                    }]
                });
                
                while (outputs.length > 0) {
                    const newOutputs = XLN.processServerInput(xlnEnv, {
                        serverTxs: [],
                        entityInputs: outputs
                    });
                    outputs.splice(0, outputs.length, ...newOutputs);
                }
                
                addLog(`🎯 Simulated chat: ${from} → ${entityId}: "${message}"`, 'info');
                $$invalidate('xlnEnv', xlnEnv);
            };

            const simulateStress = () => {
                if (!xlnEnv) return;
                
                currentTimeIndex = -1;
                $$invalidate('currentTimeIndex', currentTimeIndex);
                
                const entities = ['chat', 'trading', 'governance'];
                const users = ['alice', 'bob', 'carol', 'david', 'eve'];
                const txCount = 5 + Math.floor(Math.random() * 10);
                
                const entityInputs = entities.map(entityId => ({
                    entityId,
                    signerId: 'alice',
                    entityTxs: Array.from({ length: txCount }, (_, i) => ({
                        type: 'chat',
                        data: {
                            from: users[i % users.length],
                            message: `Stress test message ${i + 1} for ${entityId}`
                        }
                    }))
                }));
                
                let outputs = XLN.processServerInput(xlnEnv, {
                    serverTxs: [],
                    entityInputs
                });
                
                while (outputs.length > 0) {
                    const newOutputs = XLN.processServerInput(xlnEnv, {
                        serverTxs: [],
                        entityInputs: outputs
                    });
                    outputs.splice(0, outputs.length, ...newOutputs);
                }
                
                addLog(`💪 Stress test completed: ${txCount} txs per entity across ${entities.length} entities`, 'info');
                $$invalidate('xlnEnv', xlnEnv);
            };

            // Time machine functions
            const stepBackward = () => {
                const history = XLN.getHistory();
                if (history.length === 0) return;
                
                if (currentTimeIndex === -1) {
                    currentTimeIndex = Math.max(0, history.length - 2);
                } else {
                    currentTimeIndex = Math.max(0, currentTimeIndex - 1);
                }
                $$invalidate('currentTimeIndex', currentTimeIndex);
            };

            const stepForward = () => {
                const history = XLN.getHistory();
                if (history.length === 0) return;
                
                if (currentTimeIndex === -1) {
                    return;
                } else if (currentTimeIndex < history.length - 2) {
                    currentTimeIndex++;
                } else {
                    currentTimeIndex = -1;
                }
                $$invalidate('currentTimeIndex', currentTimeIndex);
            };

            const goToLive = () => {
                currentTimeIndex = -1;
                $$invalidate('currentTimeIndex', currentTimeIndex);
            };

            const goToStart = () => {
                const history = XLN.getHistory();
                if (history.length > 0) {
                    currentTimeIndex = 0;
                    $$invalidate('currentTimeIndex', currentTimeIndex);
                }
            };

            const resetHistory = () => {
                XLN.resetHistory();
                currentTimeIndex = -1;
                $$invalidate('currentTimeIndex', currentTimeIndex);
            };

            // Initialize XLN environment
            const initializeEnvironment = async () => {
                try {
                    // Try to import XLN module
                    try {
                        XLN = await import('./dist/server.js');
                        addLog('✅ XLN module imported successfully', 'success');
                    } catch (error) {
                        addLog('❌ Failed to import XLN module: ' + error.message, 'error');
                        // Create a mock XLN for development
                        XLN = {
                            main: async () => ({ replicas: new Map(), height: 0, timestamp: Date.now() }),
                            processServerInput: () => [],
                            getHistory: () => [],
                            getSnapshot: () => null,
                            resetHistory: () => {}
                        };
                    }
                    
                    xlnEnv = await XLN.main();
                    window.xlnEnv = xlnEnv;
                    addLog('🎯 XLN Environment loaded successfully', 'success');
                    $$invalidate('xlnEnv', xlnEnv);
                    return true;
                } catch (error) {
                    addLog('❌ Failed to load XLN environment: ' + error.message, 'error');
                    return false;
                }
            };

            // Initialize on component mount
            initializeEnvironment().then(success => {
                if (success) {
                    addLog('🎉 Svelte Sonnet Wallet initialized successfully!', 'success');
                }
            });

            // Auto-reload functionality
            const checkForChanges = async () => {
                try {
                    const response = await fetch('./dist/server.js', { method: 'HEAD' });
                    const modified = response.headers.get('last-modified');
                    
                    if (lastModified && modified !== lastModified) {
                        addLog('🔄 Module updated, reloading...', 'info');
                        setTimeout(() => {
                            window.location.reload();
                        }, 500);
                    }
                    lastModified = modified;
                } catch (error) {
                    // Silent fail for auto-reload
                }
            };

            setInterval(checkForChanges, 10000);

            // Render function
            return {
                c() {
                    return `
                        <div class="reload-indicator" class:show={false}>🔄 Reloading...</div>
                        
                        <div class="container">
                            <div class="header">
                                <h1>🧠 XLN Sonnet Wallet</h1>
                                <div class="status-bar">${statusText}</div>
                            </div>

                            ${serverData && (serverData.serverInput || serverData.serverOutputs?.length) ? `
                                <div class="server-io-container">
                                    <div class="server-column">
                                        <div class="server-column-header">
                                            📨 Server Input (What's happening this tick)
                                            <span style="font-weight: normal; color: #6c757d; font-size: 0.85em;">
                                                ${serverData.isHistorical ? ' 🕰️ Historical' : ' ⚡ Current'}
                                            </span>
                                        </div>
                                        
                                        <div class="server-section">
                                            <h4>🖥️ Server Transactions</h4>
                                            <div>
                                                ${serverData.serverInput?.serverTxs.length ? 
                                                    serverData.serverInput.serverTxs.map(tx => `
                                                        <div class="input-item">
                                                            <strong>🖥️ ${tx.type}</strong>: ${tx.entityId}:${tx.signerId}
                                                            ${tx.data.isProposer ? ' (👑 Proposer)' : ' (✅ Validator)'}
                                                            ${tx.data.config ? `
                                                                <br>⚙️ <strong>Config:</strong>
                                                                <br>  • Mode: ${tx.data.config.mode}
                                                                <br>  • Threshold: ${tx.data.config.threshold}
                                                                <br>  • Validators: [${tx.data.config.validators.join(', ')}]
                                                                <br>  • Voting Shares:
                                                                ${Object.entries(tx.data.config.shares).map(([validator, shares]) => 
                                                                    `<br>    ${validator}: ${shares} shares`
                                                                ).join('')}
                                                            ` : ''}
                                                        </div>
                                                    `).join('') : 
                                                    '<div class="no-inputs">No server transactions</div>'
                                                }
                                            </div>
                                        </div>
                                        
                                        <div class="server-section">
                                            <h4>🔄 Entity Inputs</h4>
                                            <div>
                                                ${serverData.serverInput?.entityInputs.length ? 
                                                    serverData.serverInput.entityInputs.map(input => `
                                                        <div class="input-item">
                                                            <strong>${input.entityId}:${input.signerId}</strong>
                                                            ${input.entityTxs?.length ? `
                                                                <br>📝 <strong>${input.entityTxs.length} transactions:</strong>
                                                                ${input.entityTxs.map((tx, i) => {
                                                                    if (tx.type === 'chat') {
                                                                        return `<br>  ${i+1}. 💬 Chat: "${tx.data.message}" (from: ${tx.data.from})`;
                                                                    } else if (tx.type === 'propose') {
                                                                        return `<br>  ${i+1}. 📝 Propose: "${tx.data.action.data.message}" (by: ${tx.data.proposer})`;
                                                                    } else if (tx.type === 'vote') {
                                                                        return `<br>  ${i+1}. 🗳️ Vote: ${tx.data.choice} on ${tx.data.proposalId.slice(0,12)}... (by: ${tx.data.voter})`;
                                                                    }
                                                                    return `<br>  ${i+1}. ${tx.type}`;
                                                                }).join('')}
                                                            ` : ''}
                                                            ${input.proposedFrame ? `
                                                                <br>${input.precommits?.size > 0 ? "📋 <strong>Commit Notification:</strong>" : "🎯 <strong>Proposed Frame:</strong>"}
                                                                <br>  • Hash: ${input.proposedFrame.hash}
                                                                <br>  • Height: ${input.proposedFrame.height}
                                                                <br>  • Transactions: ${input.proposedFrame.txs.length}
                                                                <br>  • Signatures: ${input.proposedFrame.signatures.size}
                                                            ` : ''}
                                                            ${input.precommits?.size > 0 ? `
                                                                <br>✅ <strong>${input.precommits.size} precommits from:</strong>
                                                                ${Array.from(input.precommits.entries()).map(([signerId, signature]) => 
                                                                    `<br>  • ${signerId}: ${signature.slice(0,16)}...`
                                                                ).join('')}
                                                            ` : ''}
                                                        </div>
                                                    `).join('') :
                                                    '<div class="no-inputs">No entity inputs</div>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="server-column">
                                        <div class="server-column-header">
                                            📤 Server Output (What's being sent and where)
                                            <span style="font-weight: normal; color: #6c757d; font-size: 0.85em;">
                                                ${serverData.isHistorical ? ' 🕰️ Historical' : ' ⚡ Current'}
                                            </span>
                                        </div>
                                        
                                        <div class="server-section">
                                            <h4>🚀 Entity Outputs</h4>
                                            <div>
                                                ${serverData.serverOutputs?.length ? 
                                                    serverData.serverOutputs.map((output, index) => `
                                                        <div class="input-item">
                                                            <strong>📤 ${index + 1}. → ${output.signerId}</strong>
                                                            ${output.entityTxs?.length ? `
                                                                <br>📝 <strong>${output.entityTxs.length} transactions:</strong>
                                                                ${output.entityTxs.map((tx, i) => {
                                                                    if (tx.type === 'chat') {
                                                                        return `<br>  ${i+1}. 💬 Chat: "${tx.data.message}" (from: ${tx.data.from})`;
                                                                    } else if (tx.type === 'propose') {
                                                                        return `<br>  ${i+1}. 📝 Propose: "${tx.data.action.data.message}" (by: ${tx.data.proposer})`;
                                                                    } else if (tx.type === 'vote') {
                                                                        return `<br>  ${i+1}. 🗳️ Vote: ${tx.data.choice} on ${tx.data.proposalId.slice(0,12)}... (by: ${tx.data.voter})`;
                                                                    }
                                                                    return `<br>  ${i+1}. ${tx.type}`;
                                                                }).join('')}
                                                            ` : ''}
                                                            ${output.proposedFrame ? `
                                                                <br>${output.precommits?.size > 0 ? "📋 <strong>Commit Notification:</strong>" : "🎯 <strong>Proposed Frame:</strong>"}
                                                                <br>  • Hash: ${output.proposedFrame.hash}
                                                                <br>  • Height: ${output.proposedFrame.height}
                                                                <br>  • Transactions: ${output.proposedFrame.txs.length}
                                                                <br>  • Signatures: ${output.proposedFrame.signatures.size}
                                                            ` : ''}
                                                            ${output.precommits?.size > 0 ? `
                                                                <br>✅ <strong>${output.precommits.size} precommits:</strong>
                                                                ${Array.from(output.precommits.entries()).map(([signerId, signature]) => 
                                                                    `<br>  • ${signerId}: ${signature.slice(0,16)}...`
                                                                ).join('')}
                                                            ` : ''}
                                                        </div>
                                                    `).join('') : 
                                                    '<div class="no-inputs">No entity outputs</div>'
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ` : ''}

                            <div class="entity-filter">
                                <label for="entityFilter">📂 Filter Entities:</label>
                                <select bind:value={selectedEntity}>
                                    ${entityOptions.map(option => 
                                        `<option value="${option.value}"${selectedEntity === option.value ? ' selected' : ''}>${option.label}</option>`
                                    ).join('')}
                                </select>
                            </div>

                            <div class="entities-grid">
                                ${Array.from(filteredReplicas.entries()).map(([key, replica]) => {
                                    const config = replica.state.config;
                                    const modeClass = config.mode === 'proposer-based' ? 'mode-proposer-based' : 'mode-gossip-based';
                                    const totalShares = Object.values(config.shares).reduce((sum, val) => sum + val, BigInt(0));
                                    const thresholdPercent = ((Number(config.threshold) / Number(totalShares)) * 100).toFixed(1);
                                    const shares = config.shares[replica.signerId] || BigInt(0);
                                    const sharePercent = ((Number(shares) / Number(totalShares)) * 100).toFixed(1);
                                    
                                    return `
                                        <div class="entity-card">
                                            <div class="entity-header">
                                                <div class="entity-title">${replica.entityId}:${replica.signerId} ${replica.isHistorical ? '🕰️' : ''}</div>
                                                <div class="entity-mode ${modeClass}">${config.mode}</div>
                                            </div>
                                            
                                            <div class="threshold-info">
                                                <strong>Role:</strong> ${replica.isProposer ? '👑 Proposer' : '✅ Validator'}<br>
                                                <strong>Voting Power:</strong> ${shares} / ${totalShares} shares (${sharePercent}%)<br>
                                                <strong>Consensus Threshold:</strong> ${config.threshold} / ${totalShares} shares (${thresholdPercent}%)
                                                <div class="power-bar">
                                                    <div class="power-fill" style="width: ${thresholdPercent}%"></div>
                                                </div>
                                            </div>
                                            
                                            <div class="replica-stats">
                                                <strong>📊 Replica State:</strong><br>
                                                <strong>📏 Frame Height: ${replica.state.height}</strong><br>
                                                <strong>📝 Mempool: ${replica.mempool.length} txs</strong>
                                                ${replica.mempool.length > 0 ? `<br>  ${replica.mempool.map((tx, i) => {
                                                    if (tx.type === 'chat') return `${i+1}. 💬 "${tx.data.message}" (${tx.data.from})`;
                                                    if (tx.type === 'propose') return `${i+1}. 📝 "${tx.data.action.data.message}" (${tx.data.proposer})`;
                                                    if (tx.type === 'vote') return `${i+1}. 🗳️ ${tx.data.choice} on ${tx.data.proposalId.slice(0,8)}... (${tx.data.voter})`;
                                                    return `${i+1}. ${tx.type}`;
                                                }).join('<br>  ')}` : ''}<br>
                                                <strong>💬 Messages: ${replica.state.messages.length}</strong><br>
                                                <strong>🗳️ Proposals: ${replica.state.proposals.size}</strong><br>
                                                <strong>🔢 Nonces:</strong> ${replica.state.nonces.size > 0 ? 
                                                    Array.from(replica.state.nonces.entries()).map(([user, nonce]) => `${user}:${nonce}`).join(', ') : 
                                                    'none'}<br>
                                                ${replica.proposal ? `<strong style="color: #28a745;">📝 Currently Proposing:</strong><br>
                                                  • Height: ${replica.proposal.height}<br>
                                                  • Hash: ${replica.proposal.hash}<br>
                                                  • Txs: ${replica.proposal.txs.length}<br>
                                                  • Signatures: ${replica.proposal.signatures.size}/${replica.state.config.validators.length}` : ''}
                                                ${replica.lockedFrame ? `<strong style="color: #ffc107;">🔒 Locked Frame (Precommitted):</strong><br>
                                                  • Height: ${replica.lockedFrame.height}<br>
                                                  • Hash: ${replica.lockedFrame.hash}<br>
                                                  • Txs: ${replica.lockedFrame.txs.length}` : ''}
                                            </div>
                                            
                                            <div class="messages-section">
                                                <strong>📨 ${replica.signerId}'s Message Feed:</strong>
                                                ${replica.state.messages.length > 0 ? 
                                                    replica.state.messages.map(msg => `
                                                        <div class="message ${msg.includes('[COLLECTIVE]') ? 'collective' : ''}">
                                                            ${msg}
                                                        </div>
                                                    `).join('') : 
                                                    '<div class="message">No messages yet</div>'
                                                }
                                            </div>
                                            
                                            ${replica.state.proposals.size > 0 ? `
                                                <div class="messages-section">
                                                    <strong>🗳️ ${replica.signerId}'s Proposals:</strong>
                                                    ${Array.from(replica.state.proposals.values()).map(proposal => {
                                                        const yesVoters = Array.from(proposal.votes.entries()).filter(([_, vote]) => vote === 'yes').map(([voter, _]) => voter);
                                                        const noVoters = Array.from(proposal.votes.entries()).filter(([_, vote]) => vote === 'no').map(([voter, _]) => voter);
                                                        
                                                        return `<div class="message">
                                                            <strong>ID:</strong> ${proposal.id}<br>
                                                            <strong>Proposer:</strong> ${proposal.proposer}<br>
                                                            <strong>Status:</strong> ${proposal.status}<br>
                                                            <strong>Action:</strong> ${proposal.action.data.message}<br>
                                                            <strong>Votes (${proposal.votes.size} total):</strong><br>
                                                            ${yesVoters.length > 0 ? `  ✅ YES (${yesVoters.length}): ${yesVoters.join(', ')}<br>` : ''}
                                                            ${noVoters.length > 0 ? `  ❌ NO (${noVoters.length}): ${noVoters.join(', ')}<br>` : ''}
                                                            ${yesVoters.length === 0 && noVoters.length === 0 ? '  (No votes yet)<br>' : ''}
                                                            <small>Created: ${new Date(proposal.created).toLocaleTimeString()}</small>
                                                        </div>`;
                                                    }).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>

                            <div class="actionable-tabs-container">
                                <div class="tabs-header">
                                    <button class="tab-button ${activeTab === 'controls' ? 'active' : ''}" on:click={() => switchTab('controls')}>
                                        🎮 Interactive Controls
                                    </button>
                                    <button class="tab-button ${activeTab === 'formation' ? 'active' : ''}" on:click={() => switchTab('formation')}>
                                        🏗️ Entity Formation
                                    </button>
                                </div>
                                
                                <div class="tab-content ${activeTab === 'controls' ? 'active' : ''}">
                                    <div class="control-panel">
                                        <div class="control-group">
                                            <label>📍 Select Replica:</label>
                                            <select bind:value={selectedReplica}>
                                                <option value="">Choose a replica...</option>
                                                ${replicaOptions.map(option => 
                                                    `<option value="${option.value}"${selectedReplica === option.value ? ' selected' : ''}>${option.label}</option>`
                                                ).join('')}
                                            </select>
                                        </div>
                                        <div class="control-group">
                                            <label>⚡ Select Action:</label>
                                            <select bind:value={selectedAction}>
                                                <option value="chat"${selectedAction === 'chat' ? ' selected' : ''}>💬 Chat Message</option>
                                                <option value="propose"${selectedAction === 'propose' ? ' selected' : ''}>📝 Create Proposal</option>
                                                <option value="vote"${selectedAction === 'vote' ? ' selected' : ''}>🗳️ Vote on Proposal</option>
                                            </select>
                                        </div>
                                        ${selectedAction === 'chat' ? `
                                            <div class="control-group">
                                                <label>💬 Message:</label>
                                                <input type="text" bind:value={inputMessage} placeholder="Enter your message..." />
                                            </div>
                                        ` : ''}
                                        ${selectedAction === 'propose' ? `
                                            <div class="control-group">
                                                <label>📝 Proposal:</label>
                                                <input type="text" bind:value={proposalText} placeholder="Enter proposal text..." />
                                            </div>
                                        ` : ''}
                                        ${selectedAction === 'vote' ? `
                                            <div class="control-group">
                                                <label>🗳️ Vote on Proposal:</label>
                                                <select bind:value={selectedProposal}>
                                                    <option value="">Choose a proposal...</option>
                                                    ${proposalOptions.map(option => 
                                                        `<option value="${option.value}"${selectedProposal === option.value ? ' selected' : ''}>${option.label}</option>`
                                                    ).join('')}
                                                </select>
                                                <select bind:value={voteChoice}>
                                                    <option value="yes"${voteChoice === 'yes' ? ' selected' : ''}>✅ Yes</option>
                                                    <option value="no"${voteChoice === 'no' ? ' selected' : ''}>❌ No</option>
                                                </select>
                                            </div>
                                        ` : ''}
                                        <div class="button-group">
                                            <button class="btn btn-primary" on:click={executeAction}>🚀 Execute Action</button>
                                            <button class="btn btn-secondary" on:click={() => $$invalidate('xlnEnv', xlnEnv)}>🔄 Refresh View</button>
                                            <button class="btn btn-secondary" on:click={simulateChat}>🎯 Simulate Chat</button>
                                            <button class="btn btn-secondary" on:click={simulateStress}>💪 Stress Test</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-content ${activeTab === 'formation' ? 'active' : ''}">
                                    <div class="simple-formation-panel">
                                        <div class="formation-group">
                                            <label>🏷️ Entity Name:</label>
                                            <input type="text" bind:value={entityName} placeholder="e.g., trading, chat, governance" />
                                        </div>
                                        
                                        <div class="validators-section">
                                            <h4>👥 Validators:</h4>
                                            <div>
                                                ${validators.map((validator, index) => `
                                                    <div class="validator-row">
                                                        <input type="text" class="validator-name" bind:value={validators[${index}].name} placeholder="validator name" />
                                                        <input type="number" class="validator-weight" bind:value={validators[${index}].weight} placeholder="1" min="1" />
                                                        <button class="btn btn-danger btn-small" on:click={() => removeValidator(${index})}>❌</button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <button class="btn btn-secondary" on:click={addValidator}>➕ Add New Validator</button>
                                        </div>
                                        
                                        <div class="threshold-section">
                                            <label>🎯 Threshold: <span>${threshold}</span></label>
                                            <input type="range" class="threshold-slider" bind:value={threshold} min="1" max="${totalWeight}" />
                                            <div class="threshold-info">
                                                <span>Total Weight: <span>${totalWeight}</span></span>
                                            </div>
                                        </div>
                                        
                                        <div class="button-group">
                                            <button class="btn btn-primary" on:click={createEntity}>🚀 Create Entity</button>
                                            <button class="btn btn-secondary" on:click={() => {
                                                entityName = '';
                                                validators = [
                                                    { name: 'alice', weight: 1 },
                                                    { name: 'bob', weight: 1 },
                                                    { name: 'carol', weight: 1 }
                                                ];
                                                threshold = 2;
                                                $$invalidate('entityName', entityName);
                                                $$invalidate('validators', validators);
                                                $$invalidate('threshold', threshold);
                                            }}>🗑️ Clear Form</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            ${logs.length > 0 ? `
                                <div class="debug-log">
                                    <strong>📊 Debug Log:</strong><br>
                                    ${logs.slice(-10).map(log => 
                                        `[${log.timestamp}] ${log.message}`
                                    ).join('\\n')}
                                </div>
                            ` : ''}
                        </div>

                        <!-- Time Machine -->
                        <div class="time-machine">
                            <div class="time-machine-main">
                                <div class="time-info-compact ${timeMachineData.isCurrent ? 'current' : ''}">
                                    <span>${timeMachineData.info}</span>
                                </div>
                                <div class="time-nav-controls">
                                    <button class="time-btn-compact" on:click={stepBackward} title="Step Back (← arrow)">⏪</button>
                                    <button class="time-btn-compact" on:click={stepForward} title="Step Forward (→ arrow)">⏩</button>
                                    <button class="time-btn-compact live" on:click={goToLive} title="Go to Current (End key)">⚡ LIVE</button>
                                </div>
                                <div class="time-utility-controls">
                                    <button class="time-btn-mini" on:click={goToStart} title="Go to Start (Home key)">⏮️</button>
                                    <button class="time-btn-mini warning" on:click={resetHistory} title="Clear History">🗑️</button>
                                </div>
                            </div>
                            <div class="time-slider-container">
                                <input type="range" class="time-slider" 
                                       min="0" max="${timeMachineData.max}" 
                                       bind:value={timeMachineData.value} 
                                       ${timeMachineData.disabled ? 'disabled' : ''}
                                       on:input={(e) => {
                                           const history = XLN.getHistory();
                                           const sliderValue = parseInt(e.target.value);
                                           const maxMeaningfulIndex = Math.max(0, history.length - 2);
                                           
                                           if (sliderValue > maxMeaningfulIndex) {
                                               currentTimeIndex = -1;
                                           } else {
                                               currentTimeIndex = sliderValue;
                                           }
                                           $$invalidate('currentTimeIndex', currentTimeIndex);
                                       }} />
                            </div>
                        </div>
                    `;
                },
                
                m(target) {
                    target.innerHTML = this.c();
                    
                    // Set up event listeners for keyboard shortcuts
                    document.addEventListener('keydown', (e) => {
                        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                        
                        switch(e.key) {
                            case 'ArrowLeft':
                                e.preventDefault();
                                stepBackward();
                                break;
                            case 'ArrowRight':
                                e.preventDefault();
                                stepForward();
                                break;
                            case 'Home':
                                e.preventDefault();
                                goToStart();
                                break;
                            case 'End':
                                e.preventDefault();
                                goToLive();
                                break;
                        }
                    });
                },
                
                p() {
                    // Update DOM on state changes
                    const target = document.getElementById('app');
                    if (target) {
                        target.innerHTML = this.c();
                    }
                },
                
                d() {
                    // Cleanup
                }
            };
        });

        // Initialize the Svelte app
        const app = new App({
            target: document.getElementById('app')
        });
    </script>
</body>
</html>